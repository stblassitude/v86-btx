<!doctype html>
<title>BTX</title>

<script src="libv86.js"></script>
<script>
  "use strict";
  window.onload = function() {
    var btxSocket = new WebSocket('ws://127.0.0.1:8080/btxws')
    btxSocket.binaryType = "arraybuffer";
    var emulator = window.emulator = new V86Starter({
      memory_size: 32 * 1024 * 1024,
      vga_memory_size: 2 * 1024 * 1024,
      screen_container: document.getElementById("screen_container"),
      bios: {
        url: "seabios.bin",
      },
      vga_bios: {
        url: "vgabios.bin",
      },
      cdrom: {
        url: "btx.iso",
      },
      autostart: true,
    });
    emulator.add_listener('serial2-output-char', function(c) {
      var ab = new ArrayBuffer(1)
      var abv = new Uint8Array(ab)
      abv[0] = c.charCodeAt(0)
      btxSocket.send(ab)
      // console.log("sent " + c)
    })
    btxSocket.onmessage = function(event) {
      var data = event.data
      if (event.data instanceof ArrayBuffer) {
        data = new Uint8Array(event.data)
        emulator.serial_send_bytes(2, data)
        // console.log("received " + data)
      } else {
        console.log("received data in unsupported format: " + data)
      }
    }
  }
</script>

<!-- A minimal structure for the ScreenAdapter defined in browser/screen.js -->
<div id="screen_container">
  <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
  <canvas style="display: none"></canvas>
</div>